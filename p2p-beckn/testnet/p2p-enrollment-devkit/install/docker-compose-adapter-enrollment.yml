services:
  # ============================================
  # Core Infrastructure Services
  # ============================================
  
  # Redis - Caching Service
  redis:
    image: redis:alpine
    container_name: redis-enrollment
    ports:
      - "6379:6379"
    networks:
      - beckn_enrollment_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
  
  # ============================================
  # Beckn Onix Adapters
  # ============================================
  
  onix-bap:
    image: fidedocker/onix-adapter
    container_name: onix-enrollment-bap
    platform: linux/amd64
    networks:
      - beckn_enrollment_network
    ports:
      - "8081:8081"
    environment:
      CONFIG_FILE: "/app/config/local-simple.yaml"
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: root
      REDIS_ADDR: redis-enrollment:6379
      RABBITMQ_ADDR: rabbitmq:5672
      RABBITMQ_USER: admin
      RABBITMQ_PASS: admin123
    volumes:
      - ../config:/app/config
      - ../schemas:/app/schemas
    command: ["./server", "--config=/app/config/local-enrollment-bap.yaml"]
    depends_on:
      redis:
        condition: service_healthy

  onix-bpp:
    image: fidedocker/onix-adapter
    container_name: onix-enrollment-bpp
    platform: linux/amd64
    networks:
      - beckn_enrollment_network
    ports:
      - "8082:8082"
    environment:
      CONFIG_FILE: "/app/config/local-simple.yaml"
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: root
      REDIS_ADDR: redis-enrollment:6379
      RABBITMQ_ADDR: rabbitmq:5672
      RABBITMQ_USER: admin
      RABBITMQ_PASS: admin123
    volumes:
      - ../config:/app/config
      - ../schemas:/app/schemas
    command: ["./server", "--config=/app/config/local-enrollment-bpp.yaml"]
    depends_on:
      redis:
        condition: service_healthy

  # ============================================
  # Sandbox Services (Mock BAP/BPP implementations)
  # ============================================

  sandbox-bap:
    container_name: sandbox-enrollment-bap
    image: fidedocker/sandbox-2.0:latest
    platform: linux/amd64
    environment:
      - NODE_ENV=production
      - PORT=3001
    ports:
      - "3001:3001"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3001/api/health"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - beckn_enrollment_network
    
  sandbox-bpp:
    container_name: sandbox-enrollment-bpp
    image: fidedocker/sandbox-2.0:latest
    platform: linux/amd64
    environment:
      - NODE_ENV=production
      - PORT=3002
      - PERSONA=bpp
    ports:
      - "3002:3002"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3002/api/health"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - beckn_enrollment_network

networks:
  beckn_enrollment_network:
    name: beckn_enrollment_network
    driver: bridge

