# Docker Compose for P2P Trading with locally-built onix-adapter-deg image
# This ensures plugin compatibility by building the adapter and plugins together.
#
# Build and run:
#   docker compose -f docker-compose-adapter-p2p-local.yml build
#   docker compose -f docker-compose-adapter-p2p-local.yml up

services:
  # ============================================
  # Core Infrastructure Services
  # ============================================

  # Redis - Caching Service
  redis:
    image: redis:alpine
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - beckn_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  onix-bap:
    build:
      context: ../../..
      dockerfile: build/Dockerfile.onix-adapter-deg
      additional_contexts:
        beckn-onix: ../../../../beckn-onix
    image: onix-adapter-deg:local
    container_name: onix-bap
    platform: linux/amd64
    networks:
      - beckn_network
    ports:
      - "8081:8081"
    environment:
      CONFIG_FILE: "/app/config/local-simple.yaml"
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: root
      REDIS_ADDR: redis:6379
      RABBITMQ_ADDR: rabbitmq:5672
      RABBITMQ_USER: admin
      RABBITMQ_PASS: admin123
    volumes:
      - ../config:/app/config
      - ../schemas:/app/schemas
    command: ["./server", "--config=/app/config/local-p2p-bap.yaml"]

  onix-bpp:
    build:
      context: ../../..
      dockerfile: build/Dockerfile.onix-adapter-deg
      additional_contexts:
        beckn-onix: ../../../../beckn-onix
    image: onix-adapter-deg:local
    container_name: onix-bpp
    platform: linux/amd64
    networks:
      - beckn_network
    ports:
      - "8082:8082"
    environment:
      CONFIG_FILE: "/app/config/local-simple.yaml"
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: root
      REDIS_ADDR: redis:6379
      RABBITMQ_ADDR: rabbitmq:5672
      RABBITMQ_USER: admin
      RABBITMQ_PASS: admin123
    volumes:
      - ../config:/app/config
      - ../schemas:/app/schemas
    command: ["./server", "--config=/app/config/local-p2p-bpp.yaml"]

  onix-utilitybpp:
    build:
      context: ../../..
      dockerfile: build/Dockerfile.onix-adapter-deg
      additional_contexts:
        beckn-onix: ../../../../beckn-onix
    image: onix-adapter-deg:local
    container_name: onix-utilitybpp
    platform: linux/amd64
    networks:
      - beckn_network
    ports:
      - "8083:8083"
    environment:
      CONFIG_FILE: "/app/config/local-simple.yaml"
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: root
      REDIS_ADDR: redis:6379
      RABBITMQ_ADDR: rabbitmq:5672
      RABBITMQ_USER: admin
      RABBITMQ_PASS: admin123
    volumes:
      - ../config:/app/config
      - ../schemas:/app/schemas
    command: ["./server", "--config=/app/config/local-p2p-utilitybpp.yaml"]

  sandbox-bap:
    container_name: sandbox-bap

    image: fidedocker/sandbox-2.0:latest
    platform: linux/amd64

    environment:
      - NODE_ENV=production
      - PORT=3001
    ports:
      - "3001:3001"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3001/api/health"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - beckn_network

  sandbox-bpp:
    container_name: sandbox-bpp

    image: fidedocker/sandbox-2.0:latest
    platform: linux/amd64

    environment:
      - NODE_ENV=production
      - PORT=3002
      - PERSONA=bpp  # bpp persona
    ports:
      - "3002:3002"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3002/api/health"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - beckn_network

  sandbox-utilitybpp:
    container_name: sandbox-utilitybpp

    image: fidedocker/sandbox-2.0:latest
    platform: linux/amd64

    environment:
      - NODE_ENV=production
      - PORT=3003
      - PERSONA=utility-bpp  # utility-bpp persona
    ports:
      - "3003:3003"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3003/api/health"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - beckn_network

networks:
  beckn_network:
    name: beckn_network
    driver: bridge
